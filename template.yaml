AWSTemplateFormatVersion: '2010-09-09'
Transform: 'AWS::Serverless-2016-10-31'
Description: An app that sends a daily email message for each HSK level with a vocab word
Parameters:
  WordsBucketName:
    Type: String
  WordsBucketKey:
    Type: String
  ListsBucketName:
    Type: String
  ListsBucketKey:
    Type: String
  DomainName:
    Type: String
  SubNotifyEmail:
    Type: String
  DynamoBackupsS3BucketName:
    Type: String
  Stage:
    Type: String

Globals:
  Api:
    Cors:
      AllowMethods: "'OPTIONS,POST,GET'"
      AllowHeaders: "'*'"
      AllowOrigin: "'*'"

Resources:

####################################################################################################
# API Gateway
####################################################################################################

  VocabAppApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      Auth:
        DefaultAuthorizer: CognitoAuthorizer
        Authorizers:
          CognitoAuthorizer:
            UserPoolArn: !GetAtt UserPool.Arn

####################################################################################################
# Lambda functions
####################################################################################################

  SendDailyEmail:
    Type: 'AWS::Serverless::Function'
    Properties:
      FunctionName: !Sub SendDailyEmail-${Stage}
      Handler: app.lambda_handler
      Runtime: python3.7
      CodeUri: src/send_daily_email
      Description: A function that sends a daily email to subscribers with a vocab word for each HSK level
      Timeout: 120
      Policies:
        - SESCrudPolicy:
            IdentityName: haohaotiantian.com
        - S3ReadPolicy:
            BucketName: !Ref WordsBucketName
        - S3ReadPolicy:
            BucketName: !Ref VocabAnnouncementsBucket
        - DynamoDBCrudPolicy:
            TableName: !Ref DynamoDBTable
        - DynamoDBCrudPolicy:
            TableName: !Ref WordHistoryDynamoDBTable
        - DynamoDBCrudPolicy:
            TableName: !Ref SubscriberContactListDynamoDBTable
      Environment:
        Variables:
          SUB_TOPIC_ARN: !Ref NotificationTopic
          WORDS_BUCKET_NAME: !Ref WordsBucketName
          WORDS_BUCKET_KEY: !Ref WordsBucketKey
          LISTS_BUCKET_NAME: !Ref ListsBucketName
          LISTS_BUCKET_KEY: !Ref ListsBucketKey
          ANNOUNCEMENTS_BUCKET: !Ref VocabAnnouncementsBucket
          DYNAMODB_TABLE_NAME: !Ref DynamoDBTable
          TABLE_NAME: !Ref WordHistoryDynamoDBTable
          CONTACT_TABLE_NAME: !Ref SubscriberContactListDynamoDBTable
          STAGE: !Ref Stage
      Events:
        DailySchedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 20 * * ? *)
      Layers:
      - !Ref Layer

  SampleVocab:
    Type: 'AWS::Serverless::Function'
    Properties:
      FunctionName: !Sub SampleVocab-${Stage}
      Handler: app.lambda_handler
      Runtime: python3.7
      CodeUri: src/sample_vocab
      Description: A function that returns five random words for each HSK level
      MemorySize: 128
      Timeout: 120
      Policies:
        - S3ReadPolicy:
            BucketName: !Ref WordsBucketName
      Environment:
        Variables:
          WORDS_BUCKET_NAME: !Ref WordsBucketName
          WORDS_BUCKET_KEY: !Ref WordsBucketKey
      Events:
        SampleVocabApi:
          RestApiId: !Ref VocabAppApi
          Type: Api
          Properties:
            Path: /sample_vocab
            Method: GET
      Layers:
      - !Ref Layer

  WordHistory:
    Type: 'AWS::Serverless::Function'
    Properties:
      FunctionName: !Sub WordHistory-${Stage}
      Handler: app.lambda_handler
      Runtime: python3.7
      CodeUri: src/word_history
      Description: A function that returns a list of previous daily words.
      MemorySize: 128
      Timeout: 120
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref WordHistoryDynamoDBTable
      Environment:
        Variables:
          DYNAMODB_TABLE_NAME: !Ref DynamoDBTable
          TABLE_NAME: !Ref WordHistoryDynamoDBTable
      Events:
        WordHistoryApi:
          RestApiId: !Ref VocabAppApi
          Type: Api
          Properties:
            Path: /history
            Method: GET

  Subscribe:
    Type: 'AWS::Serverless::Function'
    Properties:
      FunctionName: !Sub VocabSubscribe-${Stage}
      Handler: app.lambda_handler
      Runtime: python3.7
      CodeUri: src/subscribe
      Description: A function that takes an HSK level and email address inputs and subscribes to a topic.
      MemorySize: 128
      Timeout: 120
      Policies:
        - SESCrudPolicy:
            IdentityName: haohaotiantian.com
        - DynamoDBCrudPolicy:
            TableName: !Ref SubscriberContactListDynamoDBTable
        - DynamoDBCrudPolicy:
            TableName: !Ref DynamoDBTable
      Environment:
        Variables:
          SUB_TOPIC_ARN: !Ref NotificationTopic
          LISTS_BUCKET_NAME: !Ref ListsBucketName
          LISTS_BUCKET_KEY: !Ref ListsBucketKey
          STAGE: !Ref Stage
          DYNAMODB_TABLE_NAME: !Ref DynamoDBTable
          TABLE_NAME: !Ref SubscriberContactListDynamoDBTable
          # USER_POOL_CLIENT_ID: !Ref UserPoolClientId
          # USER_POOL_ID: !Ref UserPoolId
      Events:
        SubscribeApi:
          RestApiId: !Ref VocabAppApi
          Type: Api
          Properties:
            Path: /sub
            Method: POST
      Layers:
      - !Ref Layer

  Unsubscribe:
    Type: 'AWS::Serverless::Function'
    Properties:
      FunctionName: !Sub VocabUnsubscribe-${Stage}
      Handler: app.lambda_handler
      Runtime: python3.7
      CodeUri: src/unsubscribe
      Description: A function that unsubscribes the user from the given HSK level or from all levels.
      MemorySize: 128
      Timeout: 120
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SubscriberContactListDynamoDBTable
        - DynamoDBCrudPolicy:
            TableName: !Ref DynamoDBTable
      Environment:
        Variables:
          STAGE: !Ref Stage
          TABLE_NAME: !Ref SubscriberContactListDynamoDBTable
          DYNAMODB_TABLE_NAME: !Ref DynamoDBTable
      Events:
        UnsubscribeApi:
          RestApiId: !Ref VocabAppApi
          Type: Api
          Properties:
            Path: /unsub
            Method: POST

    GetUserData:
      Type: 'AWS::Serverless::Function'
      Properties:
        FunctionName: !Sub GetUserData-${Stage}
        Handler: app.lambda_handler
        Runtime: python3.7
        CodeUri: src/get_user_data
        Description: A function that returns details for a specific user.
        MemorySize: 128
        Timeout: 120
        Policies:
          - DynamoDBCrudPolicy:
              TableName: !Ref DynamoDBTable
        Events:
          GetUserDataApi:
            Type: Api
            Properties:
              RestApiId: !Ref VocabAppApi
              Path: /user_data
              Method: GET
              Auth:
                Authorizers:
                  CognitoAuthorizer:
                    UserPoolArn: !GetAtt UserPool.Arn

  BackupDynamoToS3:
    Type: 'AWS::Serverless::Function'
    Properties:
      FunctionName: !Sub BackupDynamoToS3-${Stage}
      Handler: app.lambda_handler
      Runtime: python3.7
      CodeUri: src/backup_dynamo_s3
      Description: A function that scans the contact list database in DynamoDB and saves a back-up to S3
      MemorySize: 128
      Timeout: 120
      Policies:
        - S3WritePolicy:
            BucketName: !Ref DynamoBackupsS3BucketName
        - DynamoDBCrudPolicy:
            TableName: !Ref SubscriberContactListDynamoDBTable
      Environment:
        Variables:
          BACKUPS_BUCKET_NAME: !Ref DynamoBackupsS3BucketName
          TABLE_NAME: !Ref SubscriberContactListDynamoDBTable
      Events:
        WeeklyCloudWatchEvent:
          Type: Schedule
          Properties:
            Schedule: cron(0 16 ? * FRI *)

  Layer:
    # Shared Python module that returns a random vocab word
    Type: 'AWS::Serverless::LayerVersion'
    Properties:
      ContentUri: src/layer
      CompatibleRuntimes:
        - python3.7

####################################################################################################
# API Gateway permissions
# Using a workaround described here: https://github.com/awslabs/serverless-application-model/issues/59
####################################################################################################

  SampleVocabLambdaPermission:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref SampleVocab
      Principal: apigateway.amazonaws.com

  WordHistoryPermission:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref WordHistory
      Principal: apigateway.amazonaws.com

  SubscribeLambdaPermission:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref Subscribe
      Principal: apigateway.amazonaws.com

  UnsubscribeLambdaPermission:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref Unsubscribe
      Principal: apigateway.amazonaws.com

####################################################################################################
# DynamoDB table
####################################################################################################

  DynamoDBTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    Properties:
      TableName: !Sub DynamoDBTable-${Stage}
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      BillingMode: PAY_PER_REQUEST
      ProvisionedThroughput:
        ReadCapacityUnits: 0
        WriteCapacityUnits: 0

  WordHistoryDynamoDBTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    Properties:
      TableName: !Sub WordHistory-${Stage}
      AttributeDefinitions:
        - AttributeName: ListId
          AttributeType: S
        - AttributeName: Date
          AttributeType: S
      KeySchema:
        - AttributeName: ListId
          KeyType: HASH
        - AttributeName: Date
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
      ProvisionedThroughput:
        ReadCapacityUnits: 0
        WriteCapacityUnits: 0

  SubscriberContactListDynamoDBTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    Properties:
      TableName: !Sub SubscriberContactList-${Stage}
      AttributeDefinitions:
        - AttributeName: ListId
          AttributeType: S
        - AttributeName: SubscriberEmail
          AttributeType: S
      KeySchema:
        - AttributeName: ListId
          KeyType: HASH
        - AttributeName: SubscriberEmail
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
      ProvisionedThroughput:
        ReadCapacityUnits: 0
        WriteCapacityUnits: 0

####################################################################################################
# S3 bucket for email announcements
####################################################################################################

  VocabAnnouncementsBucket:
    Type: AWS::S3::Bucket
    Properties:
      AccessControl: Private
      BucketName: !Sub hhtt-email-announcements-${Stage}
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

####################################################################################################
# Cognito & authentication workflow Lambda functions
####################################################################################################

  UserPool:
    Type: "AWS::Cognito::UserPool"
    Properties:
      UserPoolName: !Sub VocabAppUserPool-${Stage}
      Schema:
        - Name: email
          AttributeDataType: String
          Mutable: true
          Required: true
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireLowercase: false
          RequireNumbers: false
          RequireSymbols: false
          RequireUppercase: false
      UsernameAttributes:
        - email
      MfaConfiguration: "OFF"
      LambdaConfig:
        PreSignUp: !GetAtt PreSignUp.Arn
        # PostConfirmation: !GetAtt PostConfirmation.Arn
        DefineAuthChallenge: !GetAtt DefineAuthChallenge.Arn
        CreateAuthChallenge: !GetAtt CreateAuthChallenge.Arn
        VerifyAuthChallengeResponse: !GetAtt VerifyAuthChallengeResponse.Arn

  PreSignUp:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/user_pool_triggers/pre_sign_up/
      Handler: app.lambda_handler
      Runtime: python3.7

  # PostConfirmation:
  #   Type: AWS::Serverless::Function
  #   Properties:
  #     CodeUri: src/user_pool_triggers/post_confirmation/
  #     Handler: app.lambda_handler
  #     Runtime: python3.7

  DefineAuthChallenge:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/user_pool_triggers/define_auth_challenge/
      Handler: app.lambda_handler
      Runtime: python3.7
  
  CreateAuthChallenge:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/user_pool_triggers/create_auth_challenge/
      Handler: app.lambda_handler
      Runtime: python3.7
      Environment:
        Variables:
          STAGE: !Ref Stage
      Policies:
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - ses:SendEmail
              Resource: "*"
  
  VerifyAuthChallengeResponse:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/user_pool_triggers/verify_auth_challenge_response/
      Handler: app.lambda_handler
      Runtime: python3.7
      Role: !GetAtt VerifyAuthChallengeRole.Arn
  
  # Creatinging a role to attach SetUserAttributesPolicy to
  VerifyAuthChallengeRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - 'sts:AssumeRole'
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

  # Giving the VerifyAuthChallenge role the permissions to update the user's email to verified
  SetUserAttributesPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: allow-set-user-attributes
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - cognito-idp:AdminUpdateUserAttributes
            Resource:
              - !GetAtt UserPool.Arn
      Roles:
        - !Ref VerifyAuthChallengeRole
  
 # Giving the user pool permissions to invoke the Lambda functions
  DefineAuthChallengeInvocationPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt DefineAuthChallenge.Arn
      Principal: cognito-idp.amazonaws.com
      SourceArn: !GetAtt UserPool.Arn
  CreateAuthChallengeInvocationPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt CreateAuthChallenge.Arn
      Principal: cognito-idp.amazonaws.com
      SourceArn: !GetAtt UserPool.Arn
  VerifyAuthChallengeResponseInvocationPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt VerifyAuthChallengeResponse.Arn
      Principal: cognito-idp.amazonaws.com
      SourceArn: !GetAtt UserPool.Arn
  PreSignUpInvocationPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt PreSignUp.Arn
      Principal: cognito-idp.amazonaws.com
      SourceArn: !GetAtt UserPool.Arn
  # PostConfirmationPermission:
  #   Type: AWS::Lambda::Permission
  #   Properties:
  #     Action: lambda:InvokeFunction
  #     FunctionName: !GetAtt PostConfirmation.Arn
  #     Principal: cognito-idp.amazonaws.com
  #     SourceArn: !GetAtt UserPool.Arn
  
  # User pool client only allows custom auth
  # A password is generated for each user, but they are not able to use it to login (since they will be using email)
  UserPoolClient:
    Type: "AWS::Cognito::UserPoolClient"
    Properties:
      ClientName: email-auth-client
      GenerateSecret: false
      UserPoolId: !Ref UserPool
      ExplicitAuthFlows:
        - CUSTOM_AUTH_FLOW_ONLY

####################################################################################################
# Receiving function error notifications
####################################################################################################

  CWLogsNotifications:
    Type: 'AWS::Serverless::Function'
    DependsOn:
      - SubscribeLogGroup
      - SendDailyEmailLogGroup
      - SampleVocabLogGroup
    Properties:
      FunctionName: !Sub CWLogsNotifications-${Stage}
      Handler: app.lambda_handler
      Runtime: python3.7
      CodeUri: src/cw_logs_notifications
      Description: A function that filters function logs for error messages and publishes to SNS
      MemorySize: 128
      Timeout: 120
      Policies:
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt NotificationTopic.TopicName
      Environment:
        Variables:
          SUB_TOPIC_ARN: !Ref NotificationTopic
      Events:
        SubFunctionLogs:
          Type: CloudWatchLogs
          Properties:
            LogGroupName:
              !Join [
          '',
          ['/aws/lambda/', !Sub 'SubscribeFunction-${Stage}']
        ]
            FilterPattern: "?Error ?Success"
        SendDailyLogs:
          Type: CloudWatchLogs
          Properties:
            LogGroupName:
              !Join [
          '',
          ['/aws/lambda/', !Sub 'SendDailyEmail-${Stage}']
        ]
            FilterPattern: Error
        SampleVocabLogs:
          Type: CloudWatchLogs
          Properties:
            LogGroupName:
              !Join [
          '',
          ['/aws/lambda/', !Sub 'SampleVocab-${Stage}']
        ]
            FilterPattern: Error

  NotificationTopic:
    # A topic that error notifications are published to
    Type: AWS::SNS::Topic
    Properties:
      Subscription:
      - Protocol: email
        Endpoint: !Ref SubNotifyEmail

  # Creating CloudWatch Logs groups for each function.
  # By default, a log group is only created for a function once the function is invoked.
  # We are creating log groups here to be able to subscribe the CWLogsNotification function to those log groups.
  SubscribeLogGroup:
    Type: AWS::Logs::LogGroup
    DependsOn:
      - Subscribe
    Properties:
      LogGroupName:
        !Join [
          '',
          ['/aws/lambda/', !Sub 'VocabSubscribe-${Stage}']
        ]

  SendDailyEmailLogGroup:
    Type: AWS::Logs::LogGroup
    DependsOn:
      - SendDailyEmail
    Properties:
      LogGroupName:
        !Join [
          '',
          ['/aws/lambda/', !Sub 'SendDailyEmail-${Stage}']
        ]

  SampleVocabLogGroup:
    Type: AWS::Logs::LogGroup
    DependsOn:
      - SampleVocab
    Properties:
      LogGroupName:
        !Join [
          '',
          ['/aws/lambda/', !Sub 'SampleVocab-${Stage}']
        ]

  UnsubscribeLogGroup:
    Type: AWS::Logs::LogGroup
    DependsOn:
      - Unsubscribe
    Properties:
      LogGroupName:
        !Join [
          '',
          ['/aws/lambda/', !Sub 'VocabUnsubscribe-${Stage}']
        ]

####################################################################################################
# Outputs
####################################################################################################

Outputs:
  UserPoolId:
    Description: ID of the User Pool
    Value: !Ref UserPool
  UserPoolClientId:
    Description: ID of the User Pool Client
    Value: !Ref UserPoolClient